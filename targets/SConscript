Import("env")

env.Append(
    LINT_SOURCES=[Dir(".")],
    LINKFLAGS=[
        "-specs=nosys.specs",
        "-specs=nano.specs",
    ],
    CPPDEFINES=[
        "STM32U5G9xx",
        "USE_HAL_DRIVER",
        "USE_FULL_LL_DRIVER",
        "HSE_VALUE=16000000U",
    ],
)

env.Prepend(_LIBFLAGS="-Wl,--whole-archive ")
env.Append(_LIBFLAGS=" -Wl,--no-whole-archive")

libenv = env.Clone(FW_LIB_NAME="flipper${TARGET_HW}")
libenv.ApplyLibFlags()
libenv.Append(
    CCFLAGS=[
        "-Wno-unused-parameter",
        "-Wno-double-promotion",
        "-Wno-overflow",
    ],
)

lib = libenv.StaticLibrary(
    "${FW_LIB_NAME}",
    env.get("TARGET_CFG").gatherSources(),
)
libenv.Install("${LIB_DIST_DIR}", lib)
Return("lib")
